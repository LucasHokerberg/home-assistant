platform: template
sensors:
  garden_waste:
    friendly_name: "Garden Waste"
    value_template: >
      {% set today = now().date() %}
      {% set events = state_attr('calendar.garden_waste', 'all_day') %}
      {% if events %}
        {% set days_left = 999 %}
        {% for event in events %}
          {% set event_date = as_timestamp(event.start) | timestamp_custom('%Y-%m-%d') | as_datetime %}
          {% set delta = (event_date.date() - today).days %}
          {% if delta >= 0 and delta < days_left %}
            {% set days_left = delta %}
          {% endif %}
        {% endfor %}
        {{ days_left if days_left != 999 else 'No upcoming collection' }}
      {% else %}
        No upcoming collection
      {% endif %}
